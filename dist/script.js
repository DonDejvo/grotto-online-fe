(()=>{var ae=Object.defineProperty,B=(t,e)=>{for(var i in e)ae(t,i,{get:e[i],enumerable:!0})},Et={};B(Et,{AnimatedSpriteDrawable:()=>ce,Animations:()=>he,Drawable:()=>At,OrthogonalMap:()=>de,OrthogonalMapRenderer:()=>le,Sprite:()=>D,SpriteDrawable:()=>St,tilemap:()=>fe});var he=class{static _anims=new Map;static create(t,e,i,s,n,r){this._anims.set(t,{name:t,frames:e,frameWidth:i,frameHeight:s,margin:n,spacing:r})}static get(t){return this._anims.get(t)}},S=class Tt{static _ids=0;constructor(){this._id=Tt._ids++,this._entity=null}get id(){return this._id}getComponent(e){return this._entity.getComponent(e)}broadcast(e){this._entity.broadcast(e)}start(){}update(e){}destroy(){}},At=class extends S{constructor(t){super(),this._offset=t.offset,this._size=t.size,this._zIndex=t.zIndex,this._fixed=t.fixed??!1,this._camera=t.camera,this._angle=t.angle??0}get zIndex(){return this._zIndex}set zIndex(t){this._zIndex=t}get fixed(){return this._fixed}get offset(){return this._offset}get size(){return this._size}get camera(){return this._camera}get angle(){return this._angle}set angle(t){this._angle=t}},St=class extends At{constructor(t){super(t),this._sprite=t.sprite}get zIndex(){return this._zIndex}set zIndex(t){this._zIndex=t,this._renderObject.zIndex=t,this._entity._scene.renderer.remove(this._renderObject),this._entity._scene.renderer.add(this._renderObject)}get sprite(){return this._sprite}start(){let t=this._entity.transform.getWorldPosition();this._renderObject={sprite:this._sprite,x:t.x+this._offset.x,y:t.y+this._offset.y,sx:this._entity.transform.scale.x*this._size.x,sy:this._entity.transform.scale.y*this._size.y,zIndex:this._zIndex,fixed:this._fixed,camera:this._camera,angle:this._angle},this._entity._scene.renderer.add(this._renderObject)}destroy(){this._entity._scene.renderer.remove(this._renderObject)}update(){this._fixed||this._updateRenderObject()}_updateRenderObject(){let t=this._entity.transform.getWorldPosition();this._renderObject.x=t.x+this._offset.x,this._renderObject.y=t.y+this._offset.y,this._renderObject.sx=this._entity.transform.scale.x*this._size.x,this._renderObject.sy=this._entity.transform.scale.y*this._size.y,this._renderObject.angle=this._angle}},ce=class extends St{constructor(t){super(t),this._fixed=!1,this._animPlaying=!1}isAnimPlaying(t){return this._anim&&t==this._anim.name}playAnim(t,e){this._anim=t,this._animPlaying=!0,this._animCounter=0,this._animCurFrame=0,this._animLoop=e,this._animFirst=!0}resumeAnim(){this._animPlaying=!0}pauseAnim(){this._animPlaying=!1}update(t){this._updateAnim(t),this._updateRenderObject()}_updateAnim(t){if(this._animPlaying){if(this._animFirst||this._animCounter>=this._anim.frames[this._animCurFrame].duration){if(this._animFirst=!1,this._animCounter=0,++this._animCurFrame>=this._anim.frames.length)if(this._animLoop)this._animCurFrame=0;else{this._animPlaying=!1,this.broadcast({topic:"animEnd",animName:this._anim.name});return}let e=this._anim.frames[this._animCurFrame];this._sprite.setRegion(this._anim.margin+e.x*(this._anim.frameWidth+this._anim.spacing),this._anim.margin+e.y*(this._anim.frameHeight+this._anim.spacing),this._anim.frameWidth,this._anim.frameHeight)}this._animCounter+=t}}},k=class kt{constructor(e=0,i=0){this.x=e,this.y=i}set(e,i){this.x=e,this.y=i}copy(e){return this.x=e.x,this.y=e.y,this}clone(){return new kt(this.x,this.y)}add(e){return this.x+=e.x,this.y+=e.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return this.x*=e,this.y*=e,this}lerp(e,i){return this.add(e.clone().sub(this).scale(i))}mag(){return(this.x*this.x+this.y*this.y)**.5}unit(){let e=this.mag();return e==0?(this.x=0,this.y=0):(this.x/=e,this.y/=e),this}rot(e){let i=Math.sin(e),s=Math.cos(e),n=s*this.x-i*this.y,r=i*this.x+s*this.y;return this.x=n,this.y=r,this}transformMat(e){let i=this.x,s=this.y,n=0,r=1,o=[e[0]*i+e[4]*s+e[8]*n+e[12]*r,e[1]*i+e[5]*s+e[9]*n+e[13]*r,e[2]*i+e[6]*s+e[10]*n+e[14]*r,e[3]*i+e[7]*s+e[11]*n+e[15]*r];return this.x=o[0]/o[3],this.y=o[1]/o[3],this}},D=class{constructor(t){this.texture=t,this.coords=[0,0,1,0,1,1,0,1],this.color=[1,1,1,1]}setRegion(t,e,i,s){this.coords[0]=t/this.texture.width,this.coords[1]=e/this.texture.height,this.coords[2]=(t+i)/this.texture.width,this.coords[3]=e/this.texture.height,this.coords[4]=(t+i)/this.texture.width,this.coords[5]=(e+s)/this.texture.height,this.coords[6]=t/this.texture.width,this.coords[7]=(e+s)/this.texture.height}},G=function(){let t=s=>{let n=s.createTexture();return s.bindTexture(s.TEXTURE_2D,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),n};class e{static _ids=0;_gl;constructor(n,r,o){this._params=o,this._id=e._ids++,this._gl=n,this._data=r,this._tex=t(this._gl),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,this._data)}get id(){return this._id}get width(){return this._data.width}get height(){return this._data.height}bind(){this._gl.bindTexture(this._gl.TEXTURE_2D,this._tex)}unbind(){this._gl.bindTexture(this._gl.TEXTURE_2D,null)}update(){}destroy(){this._gl.deleteTexture(this._tex)}}class i extends e{constructor(n,r,o){super(n,r,o),this._counter=0,this._curFrame=0,this._first=!0,this._initFrames()}_initFrames(){this._frames=[];let n=this._anim=this._params.anim,r=document.createElement("canvas").getContext("2d"),o=r.canvas.width=n.frameWidth,a=r.canvas.height=n.frameHeight,h=n.margin,c=n.spacing;for(let l of n.frames){r.beginPath(),r.clearRect(0,0,o,a),r.drawImage(this._data,h+l.x*(o+c),h+l.y*(a+c),o,a,0,0,o,a);let u=new Image;u.src=r.canvas.toDataURL(),this._frames.push(u)}}update(n){(this._first||this._counter>=this._anim.frames[this._curFrame].duration)&&(this._first=!1,this._counter=0,++this._curFrame>=this._frames.length&&(this._curFrame=0),this._gl.bindTexture(this._gl.TEXTURE_2D,this._tex),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,this._frames[this._curFrame])),this._counter+=n}}return{createAndSetupTexture:t,Texture:e,AnimatedTexture:i}}(),le=class extends S{constructor(t){super(),this._params=t,this._textures={tilesets:[],animatedTiles:[]},this._batches=[]}start(){let t=this._params.tilemap,e=t.getTilesets();for(let s=0;s<e.length;++s){let n=e[s],r=new G.Texture(this._entity._scene.renderer._gl,this._params.tilesets[n.name],{});this._textures.tilesets.push({name:n.name,texture:r});for(let o=0;o<n.tilecount;++o){let a=n.getTileByIndex(o);if(a.animation){let h=new G.AnimatedTexture(this._entity._scene.renderer._gl,this._params.tilesets[n.name],{anim:{frameWidth:n.tilewidth,frameHeight:n.tileheight,margin:n.margin,spacing:n.spacing,frames:a.animation.map(c=>{let l=n.getTileByIndex(c.tileid);return{x:l.x,y:l.y,duration:c.duration/1e3}})}});this._textures.animatedTiles.push({tileId:a.id,texture:h})}}}let i=t.getLayers();for(let s=0;s<i.length;++s){let n=i[s],r;switch(n.type){case"tilelayer":{r=this._entity._scene.renderer._createBatch(n.zIndex,!0,this._params.camera,!0);for(let o=0;o<n.height;++o)for(let a=0;a<n.width;++a){let h=n.getTile(a,o);if(h){let c;h.animation?c=new D(this._textures.animatedTiles.find(u=>u.tileId==h.id).texture):(c=new D(this._textures.tilesets.find(u=>u.name==h.tileset.name).texture),c.setRegion(h.tileset.margin+h.x*(t.tilewidth+h.tileset.spacing),h.tileset.margin+h.y*(t.tileheight+h.tileset.spacing),t.tilewidth,t.tileheight));let l={sprite:c,zIndex:s,fixed:!0,x:(a+n.x+.5)*t.tilewidth,y:(o+n.y+.5)*t.tileheight,sx:t.tilewidth,sy:t.tileheight,angle:0};r.spriteBatch.add(l)}}break}case"objectgroup":{let o=n.getObjects();r=this._entity._scene.renderer._createBatch(n.zIndex,!0,this._params.camera,!0);for(let a of o)if(a.gid){let h=t.getTileById(a.gid);if(!h)continue;let c;h.animation?c=new D(this._textures.animatedTiles.find(g=>g.tileId==h.id).texture):(c=new D(this._textures.tilesets.find(g=>g.name==h.tileset.name).texture),c.setRegion(h.tileset.margin+h.x*(t.tilewidth+h.tileset.spacing),h.tileset.margin+h.y*(t.tileheight+h.tileset.spacing),t.tilewidth,t.tileheight));let l=d.math.math.degToRad(a.rotation),u=new k(a.width/2,-a.height/2).rot(l),_={sprite:c,zIndex:s,fixed:!0,x:a.x+u.x,y:a.y+u.y,sx:a.width,sy:a.height,angle:l};r.spriteBatch.add(_)}break}}this._batches.push({batch:r,layerName:n.name})}}update(t){for(let i of this._textures.animatedTiles)i.texture.update(t);let e=this._params.tilemap.getLayers();for(let i of e){let s=this._batches.find(n=>n.layerName==i.name);s.batch.ambientColor[3]=i.opacity}}destroy(){for(let t of this._batches)this._entity._scene.renderer._removeBatch(t.batch);for(let t of this._textures.tilesets)t.destroy();for(let t of this._textures.animatedTiles)t.destroy()}},de=class extends S{constructor(t){super(),this._tilemap=t}get tilemap(){return this._tilemap}start(){for(let t of this._tilemap.getLayers()){if(t.type!="objectgroup")continue;let e=t.getObjects();for(let i of e)this.broadcast({topic:"tilemapObject",object:i,layer:t})}}},Bt=class{_gl;constructor(t,e,i,s){this._gl=t,this._vertexSource=e,this._fragmentSource=i,this._uniforms=s.map(n=>({name:n[0],type:n[1]}))}start(){this._program=this._gl.createProgram(),this._vertexShader=this._createShader(this._gl.VERTEX_SHADER,this._vertexSource),this._fragmentShader=this._createShader(this._gl.FRAGMENT_SHADER,this._fragmentSource),this._gl.attachShader(this._program,this._vertexShader),this._gl.attachShader(this._program,this._fragmentShader),this._gl.linkProgram(this._program),this._gl.useProgram(this._program);for(let t of this._uniforms)t.location=this._gl.getUniformLocation(this._program,"u_"+t.name)}destroy(){this._gl.deleteShader(this._vertexShader),this._gl.deleteShader(this._fragmentShader),this._gl.deleteProgram(this._program)}bind(){this._gl.useProgram(this._program)}unbind(){this._gl.useProgram(null)}supplyUniform(t,e){let i=this._uniforms.find(s=>s.name==t);if(i)switch(i.type){case"mat3":this._gl.uniformMatrix3fv(i.location,!1,e);break;case"mat4":this._gl.uniformMatrix4fv(i.location,!1,e);break;case"float":this._gl.uniform1f(i.location,e);break;case"float[]":this._gl.uniform1fv(i.location,e);break;case"vec2":this._gl.uniform2fv(i.location,e);break;case"vec3":this._gl.uniform3fv(i.location,e);break;case"vec4":this._gl.uniform4fv(i.location,e);break}}getUniform(t){return this._uniforms.find(e=>e.name==t)}_createShader(t,e){let i=this._gl.createShader(t);return this._gl.shaderSource(i,e),this._gl.compileShader(i),this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)==0&&console.log(this._gl.getShaderInfoLog(i)),i}},ue=function(){let t=`#version 300 es
    
layout (location=0) in vec2 a_position;
layout (location=1) in vec4 a_color;

uniform mat4 u_projectionViewM;

out vec4 v_color;
 
void main() {
    v_color = a_color;

    gl_Position = u_projectionViewM * vec4(a_position, 0, 1);
}
`,e=`#version 300 es
precision mediump float;

in vec4 v_color;

out vec4 outColor;
 
void main() {
    outColor = v_color;
}
`;class i{static VSIZE=6;_gl;constructor(n){this._gl=n,this._lines=[],this._drawCalls=[],this._shader=new Bt(this._gl,t,e,[["projectionViewM","mat4"]])}start(){this._shader.start(),this._vao=this._gl.createVertexArray(),this._gl.bindVertexArray(this._vao),this._vbo=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vbo),this._gl.vertexAttribPointer(0,2,this._gl.FLOAT,!1,i.VSIZE*4,0*4),this._gl.vertexAttribPointer(1,4,this._gl.FLOAT,!1,i.VSIZE*4,2*4),this._gl.bindVertexArray(null)}destroy(){this._gl.deleteBuffer(this._vbo),this._gl.deleteVertexArray(this._vao),this._shader.destroy(),this._textRenderer.destroy()}addLine(n,r,o,a,h,c){this._lines.push({x1:n,y1:r,x2:o,y2:a,color:h,camera:c})}addRect(n,r,o,a,h,c){this._lines.push({x1:n,y1:r,x2:n+o,y2:r,color:h,camera:c}),this._lines.push({x1:n+o,y1:r,x2:n+o,y2:r+a,color:h,camera:c}),this._lines.push({x1:n+o,y1:r+a,x2:n,y2:r+a,color:h,camera:c}),this._lines.push({x1:n,y1:r+a,x2:n,y2:r,color:h,camera:c})}beginFrame(){this.initBuffer(),this._lines=[]}initBuffer(){let n=[];this._drawCalls=[],this._lines.sort((r,o)=>r.camera.id-o.camera.id);for(let r of this._lines){let{x1:o,y1:a,x2:h,y2:c,color:l,camera:u}=r;if(this._drawCalls.length==0||this._drawCalls[this._drawCalls.length-1].camera.id!=u.id){let _={offset:n.length/i.VSIZE,count:2,camera:u};this._drawCalls.push(_)}else this._drawCalls[this._drawCalls.length-1].count+=2;n.push(o,a,...l),n.push(h,c,...l)}this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vbo),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(n),this._gl.STATIC_DRAW)}draw(){this._shader.bind(),this._gl.bindVertexArray(this._vao),this._gl.enableVertexAttribArray(0),this._gl.enableVertexAttribArray(1);for(let n of this._drawCalls)n.camera.begin(this._gl),this._shader.supplyUniform("projectionViewM",n.camera.projectionView),this._gl.drawArrays(this._gl.LINES,n.offset,n.count);this._gl.bindVertexArray(null)}}return{DebugDraw:i}}(),Ot=function(){let t=(i,s,n,r)=>{let o,a,h,c;switch(r){case"stretch":{h=innerWidth,c=innerHeight,o=s,a=n;break}case"fit":{let l=s/n;l>innerWidth/innerHeight?(h=innerWidth,c=innerWidth/l):(h=innerHeight*l,c=innerHeight),o=s,a=n;break}case"fill":{h=innerWidth,c=innerHeight;let l=s/n;if(l>innerWidth/innerHeight){let u=h/l;o=s,a=n}else{let u=c*l;o=s,a=n}break}}i.width=o,i.height=a,i.style.width=h+"px",i.style.height=c+"px",i.style.marginTop=(innerHeight-c)/2+"px",i.style.marginLeft=(innerWidth-h)/2+"px"};class e{constructor(){this._width=300,this._height=150,this._domElement=document.createElement("canvas"),this._context=this._domElement.getContext("webgl2")}get domElement(){return this._domElement}get context(){return this._context}start(){addEventListener("resize",()=>this._onResize()),this._onResize()}setViewportMode(s){this._viewportMode=s}setSize(s,n){this._width=s,this._height=n}_onResize(){t(this._domElement,this._width,this._height,this._viewportMode)}}return{resizeCanvas:t,GLCanvas:e}}(),pe=function(){class t{_gl;constructor(i){this._gl=i,this._texts=[]}start(){this._textCanvasCtx=document.createElement("canvas").getContext("2d"),this._textCanvasCtx.canvas.style.position="absolute",this._textCanvasCtx.canvas.style.zIndex=10,this._textCanvasCtx.canvas.style.backgroundColor="transparent",this._textCanvasCtx.canvas.style.left="0",this._textCanvasCtx.canvas.style.top="0",addEventListener("resize",()=>this._onResize()),this._onResize(),this._gl.canvas.parentElement.appendChild(this._textCanvasCtx.canvas)}_onResize(){Ot.resizeCanvas(this._textCanvasCtx.canvas,this._gl.canvas.width,this._gl.canvas.height,d.Lancelot._get()._config.viewportMode)}destroy(){}add(i,s,n,r,o={}){this._texts.push({text:i,x:s,y:n,color:o.color||"black",fontSize:o.fontSize||"12px",align:o.align||"left",fontFamily:o.fontFamily||"system-ui",camera:r,alive:!0})}draw(){this._textCanvasCtx.beginPath(),this._textCanvasCtx.clearRect(0,0,this._textCanvasCtx.canvas.width,this._textCanvasCtx.canvas.height),this._texts=this._texts.filter(i=>i.alive);for(let i of this._texts){i.alive=!1;let s=new k(i.x,i.y).transformMat(i.camera.projectionView),n=i.camera.viewport[0]+(s.x*.5+.5)*i.camera.viewport[2],r=i.camera.viewport[1]+(s.y*-.5+.5)*i.camera.viewport[3];this._textCanvasCtx.fillStyle=i.color,this._textCanvasCtx.font=i.fontSize+" "+i.fontFamily,this._textCanvasCtx.textAlign=i.align,this._textCanvasCtx.fillText(i.text,n,r)}}}return{TextRenderer:t}}(),Pt=function(){let t=`#version 300 es
     
layout (location=0) in vec2 a_position;
layout (location=1) in vec2 a_texcoord;
layout (location=2) in vec4 a_color;

uniform mat4 u_projectionViewM;

out vec2 v_texcoord;
out vec4 v_color;
 
void main() {
    v_texcoord = a_texcoord;
    v_color = a_color;

    gl_Position = u_projectionViewM * vec4(a_position, 0, 1);
}
`,e=`#version 300 es
precision mediump float;

in vec2 v_texcoord;
in vec4 v_color;

uniform sampler2D u_texture;
uniform vec4 u_ambientColor;

out vec4 outColor;
 
void main() {
    outColor = u_ambientColor * v_color * texture(u_texture, v_texcoord);
}
`;class i{static MAX_SPRITES=1e4;static VSIZE=8;static vertices=[-.5,-.5,.5,-.5,.5,.5,-.5,.5];_gl;constructor(r){this._gl=r,this._sprites=[],this._drawCalls=[]}start(){this._vao=this._gl.createVertexArray(),this._gl.bindVertexArray(this._vao),this._vbo=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vbo),this._ebo=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._ebo);let r=[];for(let o=0;o<i.MAX_SPRITES;++o)r.push(o*4,o*4+1,o*4+2,o*4,o*4+2,o*4+3);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),this._gl.STATIC_DRAW),this._gl.vertexAttribPointer(0,2,this._gl.FLOAT,!1,i.VSIZE*4,0*4),this._gl.vertexAttribPointer(1,2,this._gl.FLOAT,!1,i.VSIZE*4,2*4),this._gl.vertexAttribPointer(2,4,this._gl.FLOAT,!1,i.VSIZE*4,4*4),this._gl.bindVertexArray(null)}destroy(){this._gl.deleteBuffer(this._vao),this._gl.deleteBuffer(this._ebo),this._gl.deleteVertexArray(this._vao)}isFull(){return this._sprites.length==i.MAX_SPRITES}add(r){this._sprites.push(r)}remove(r){let o=this._sprites.indexOf(r);return o!=-1?(this._sprites.splice(o,1),!0):!1}initBuffer(){let r=[];this._drawCalls=[],this._sprites.sort((o,a)=>o.sprite.texture.id-a.sprite.texture.id);for(let o of this._sprites){let{sprite:a,x:h,y:c,sx:l,sy:u,angle:_}=o;if(this._drawCalls.length==0||this._drawCalls[this._drawCalls.length-1].texture.id!=a.texture.id){let g={offset:r.length/i.VSIZE,count:4,texture:a.texture};this._drawCalls.push(g)}else this._drawCalls[this._drawCalls.length-1].count+=4;for(let g=0;g<4;++g){let b=new k(i.vertices[g*2]*l,i.vertices[g*2+1]*u);b.rot(_),b.x+=h,b.y+=c,r.push(b.x,b.y,a.coords[g*2],a.coords[g*2+1],...a.color)}}this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vbo),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW)}draw(){this._gl.bindVertexArray(this._vao),this._gl.enableVertexAttribArray(0),this._gl.enableVertexAttribArray(1),this._gl.enableVertexAttribArray(2);for(let r of this._drawCalls)r.texture.bind(),this._gl.drawElements(this._gl.TRIANGLES,r.count/4*6,this._gl.UNSIGNED_SHORT,r.offset/4*6*2);this._gl.disableVertexAttribArray(2),this._gl.bindVertexArray(null)}}class s{_gl;constructor(r){this._gl=r,this._batches=[],this._spriteShader=new Bt(this._gl,t,e,[["projectionViewM","mat4"],["ambientColor","vec4"]]),this._debugDraw=new ue.DebugDraw(this._gl),this._textRenderer=new pe.TextRenderer(this._gl)}get debugDraw(){return this._debugDraw}get textRenderer(){return this._textRenderer}start(){this._spriteShader.start(),this._debugDraw.start(),this._textRenderer.start()}destroy(){for(let r of this._batches)this._removeBatch(r);this._spriteShader.destroy()}add(r){let o=this._batches.find(a=>!a.locked&&a.zIndex==r.zIndex&&a.fixed==r.fixed&&a.camera==r.camera&&!a.spriteBatch.isFull());o||(o=this._createBatch(r.zIndex,r.fixed,r.camera,!1)),o.spriteBatch.add(r),o.needsUpdate=!0}remove(r){for(let o of this._batches)o.spriteBatch.remove(r)&&(o.needsUpdate=!0)}render(){this._spriteShader.bind(),this._gl.viewport(0,0,this._gl.canvas.width,this._gl.canvas.height),this._gl.clearColor(0,0,0,1),this._gl.clear(this._gl.COLOR_BUFFER_BIT),this._batches.sort((r,o)=>r.zIndex-o.zIndex);for(let r of this._batches)r.needsUpdate&&(r.needsUpdate=!r.fixed,r.spriteBatch.initBuffer()),r.camera.begin(this._gl),this._spriteShader.supplyUniform("projectionViewM",r.camera.projectionView),this._spriteShader.supplyUniform("ambientColor",r.ambientColor),r.spriteBatch.draw();this._debugDraw.beginFrame(),this._debugDraw.draw(),this._textRenderer.draw()}_createBatch(r,o,a,h){let c=new i(this._gl);c.start();let l={zIndex:r,fixed:o,camera:a,locked:h,spriteBatch:c,needsUpdate:!0,ambientColor:[1,1,1,1]};return this._batches.push(l),l}_removeBatch(r){let o=this._batches.indexOf(r);o!=-1&&(this._batches.splice(o,1),r.spriteBatch.destroy())}}return{Renderer:s,SpriteBatch:i}}(),$=function(){let t=s=>new Promise((n,r)=>{let o=new Image;o.src=s,o.onload=()=>{n(o)},o.onerror=()=>{r()}}),e=async s=>await(await fetch(s)).json();class i{static _images=new Map;static _jsons=new Map;static _textures=new Map;static _shaders=new Map;static getImage(n){return this._images.get(n)}static addImage(n,r){this._images.set(n,r)}static getJson(n){return this._jsons.get(n)}static addJson(n,r){this._jsons.set(n,r)}static getTexture(n){return this._textures.get(n)}static createTexture(n,r,o,a){let h=d.Lancelot._get()._canvas.context,c;return a?c=new G.AnimatedTexture(h,r,o):c=new G.Texture(h,r,o),this._textures.set(n,c),c}static getShader(n){return this._shaders.get(n)}static createShader(n,r,o){let a=d.Lancelot._get()._canvas.context;this._shaders.set(n,Pt.createCanvasShader(a,r,o))}}return{loadImage:t,loadJson:e,AssetsManager:i}}(),fe=function(){class t{constructor(a,h,c,l,u){this.x=a,this.y=h,this.tileset=c,this.animation=l,this.properties=u}get id(){return this.tileset.name+"["+this.x+";"+this.y+"]"}getProperty(a){let h=this.properties.find(c=>c.name==a);return h?h.value:null}}class e{static _cache=new Map;static async getOrLoadFromJson(a){if(this._cache.has(a))return this._cache.get(a);let h=await $.loadJson(a),c=new e(h);return this._cache.set(a,c),c}constructor(a,h){this._params=a,this._image=h}get name(){return this._params.name}get tilecount(){return this._params.tilecount}get tilewidth(){return this._params.tilewidth}get tileheight(){return this._params.tileheight}get margin(){return this._params.margin}get spacing(){return this._params.spacing}getTileByIndex(a){if(a>=this._params.tilecount||a<0)return null;let h=this._params.tiles.find(c=>c.id==a)||{};return new t(a%this._params.columns,~~(a/this._params.columns),this,h.animation||null,h.properties||[])}}class i{constructor(a){this._tilemap=null,this._params=a,this._opacity=a.opacity}get name(){return this._params.name}get width(){return this._params.width}get height(){return this._params.height}get x(){return this._params.x}get y(){return this._params.y}get type(){return this._params.type}get zIndex(){return this._tilemap.getLayers().indexOf(this)}get opacity(){return this._opacity}set opacity(a){this._opacity=a}}class s extends i{getTile(a,h){let c=this._params.data[h*this._params.width+a];return c-1==-1?null:this._tilemap.getTileById(c)}}class n extends i{getObjects(){return this._params.objects}}class r{static async loadFromJson(a,h){let c=await $.loadJson(a),l=new r(c.width,c.height,c.tilewidth,c.tileheight);for(let u of c.layers)switch(u.type){case"tilelayer":l.addLayer(new s(u));break;case"objectgroup":l.addLayer(new n(u));break}for(let u of c.tilesets){let _;if(u.source){let g=u.source.split(/(\/|\\\/)/),b=g[g.length-1].split(".tsj")[0];_=await e.getOrLoadFromJson(h[b])}else _=new e(u);l.addTileset(_,u.firstgid)}return l}constructor(a,h,c,l){this._width=a,this._height=h,this._tilewidth=c,this._tileheight=l,this._tilesets=[],this._layers=[]}get width(){return this._width}get height(){return this._height}get tilewidth(){return this._tilewidth}get tileheight(){return this._tileheight}addLayer(a){a._tilemap=this,this._layers.push(a)}addTileset(a,h){this._tilesets.push({tileset:a,firstgid:h})}getTilesets(){return this._tilesets.map(a=>a.tileset)}getLayers(){return this._layers}getLayerByName(a){return this._layers.find(h=>h.name==a)||null}getTileById(a){let h=this._tilesets;for(let c of h){let l=c.tileset.getTileByIndex(a-c.firstgid);if(l)return l}return null}}return{Tileset:e,Layer:i,TileLayer:s,ObjectLayer:n,Tilemap:r}}(),Lt={};B(Lt,{Store:()=>_e,assets:()=>$});var _e=class{static _store={};static get(t){return this._store[t]}static set(t,e){this._store[t]=e}},It={};B(It,{Matrix:()=>O,Vector:()=>k,math:()=>ge});var ge=function(){return{clamp(t,e,i){return Math.min(Math.max(t,e),i)},sat(t){return Math.min(Math.max(t,0),1)},lerp(t,e,i){return t+(e-t)*i},map(t,e,i,s,n){return t+(e-t)*(n-i)/(s-i)},degToRad(t){return t/180*Math.PI},radToDeg(t){return t/Math.PI*180},randInt(t,e){return~~(Math.random()*(e-t+1)+t)}}}(),O=class{static create(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}static identity(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static ortho(t,e,i,s,n,r,o){let a=1/(e-i),h=1/(s-n),c=1/(r-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*a,t[13]=(n+s)*h,t[14]=(o+r)*c,t[15]=1,t}static multiply(t,e,i){let s=e[0],n=e[1],r=e[2],o=e[3],a=e[4],h=e[5],c=e[6],l=e[7],u=e[8],_=e[9],g=e[10],b=e[11],N=e[12],F=e[13],U=e[14],V=e[15],y=i[0],v=i[1],w=i[2],x=i[3];return t[0]=y*s+v*a+w*u+x*N,t[1]=y*n+v*h+w*_+x*F,t[2]=y*r+v*c+w*g+x*U,t[3]=y*o+v*l+w*b+x*V,y=i[4],v=i[5],w=i[6],x=i[7],t[4]=y*s+v*a+w*u+x*N,t[5]=y*n+v*h+w*_+x*F,t[6]=y*r+v*c+w*g+x*U,t[7]=y*o+v*l+w*b+x*V,y=i[8],v=i[9],w=i[10],x=i[11],t[8]=y*s+v*a+w*u+x*N,t[9]=y*n+v*h+w*_+x*F,t[10]=y*r+v*c+w*g+x*U,t[11]=y*o+v*l+w*b+x*V,y=i[12],v=i[13],w=i[14],x=i[15],t[12]=y*s+v*a+w*u+x*N,t[13]=y*n+v*h+w*_+x*F,t[14]=y*r+v*c+w*g+x*U,t[15]=y*o+v*l+w*b+x*V,t}},Dt={};B(Dt,{KeyListener:()=>st});var st=class Mt{static _instance=null;static _get(){return this._instance==null&&(this._instance=new Mt),this._instance}constructor(){this._prevKeysDown=new Set,this._keysDown=new Set,this._keysPressed=new Set,this._keysReleased=new Set}start(){addEventListener("keydown",e=>this._onKeyDown(e.code)),addEventListener("keyup",e=>this._onKeyUp(e.code))}static isDown(e){return this._get()._keysDown.has(e)}static isPressed(e){return this._get()._keysPressed.has(e)}static isReleased(e){return this._get()._keysReleased.has(e)}update(){this._keysPressed.clear(),this._keysReleased.clear(),this._keysDown.forEach(e=>{this._prevKeysDown.has(e)||this._keysPressed.add(e)}),this._prevKeysDown.forEach(e=>{this._keysDown.has(e)||this._keysReleased.add(e)}),this._prevKeysDown=new Set(this._keysDown)}_onKeyDown(e){this._keysDown.add(e)}_onKeyUp(e){this._keysDown.delete(e)}},Nt={};B(Nt,{Collider:()=>ye,shape:()=>me});var me=function(){class t{constructor(){this.x=0,this.y=0}setPosition(s,n){this.x=s,this.y=n}}class e extends t{constructor(s,n){super(),this.width=s,this.height=n}getLeft(){return this.x-this.width/2}getRight(){return this.x+this.width/2}getTop(){return this.y-this.height/2}getBottom(){return this.y+this.height/2}intersects(s){if(s instanceof e)return Math.abs(this.x-s.x)<(this.width+s.width)/2&&Math.abs(this.y-s.y)<(this.height+s.height)/2}clone(){let s=new e(this.width,this.height);return s.setPosition(this.x,this.y),s}}return{Shape:t,Rect:e}}(),ye=class extends S{constructor(t){super(),this._position=new k,this._offset=t.offset,this._shape=t.shape}get shape(){return this._shape}getPosition(){return this._position.clone()}setPosition(t){this._position.copy(t),this._shape.setPosition(t.x+this._offset.x,t.y+this._offset.y)}},Ft={};B(Ft,{ChannelClientController:()=>ui,ChannelServerController:()=>_i});var Ut=class{channel;ready;onConnect;onDisconnect;onMessage;constructor(t){this.channel=t,this.ready=!1}init(){this.channel.onmessage=t=>{this.onMessage&&this.onMessage(t.data)},this.channel.onopen=()=>{this.handleChannelStateChange()},this.channel.onclose=()=>{this.handleChannelStateChange()}}send(t){this.channel.send(t)}handleChannelStateChange(){this.channel.readyState=="open"?(console.log("Client connected"),this.ready=!0,this.onConnect&&this.onConnect()):(console.log("Client disconnected"),this.ready=!1,this.onDisconnect&&this.onDisconnect())}},ve=class{serverRoom;signalServer;remoteConnection;channel;onConnect;onDisconnect;onMessage;constructor(t){this.signalServer=t,this.channel=new Ut,this.serverRoom=null,t.onMessage=(e,i)=>{switch(i.type){case"offer":this.handleOffer(e,i.offer);break;case"candidate":this.remoteConnection.addIceCandidate(i.candidate);break}},this.channel.onConnect=()=>{this.onConnect&&this.onConnect(this)},this.channel.onDisconnect=()=>{this.onDisconnect&&this.onDisconnect(this)},this.channel.onMessage=e=>{this.onMessage&&this.onMessage(this,e)}}joinRoom(t){this.serverRoom=t,this.signalServer.joinRoom(t)}leaveRoom(){this.serverRoom&&(this.signalServer.leaveRoom(this.serverRoom),this.serverRoom=null),this.remoteConnection&&this.remoteConnection.close()}connect(){this.signalServer.start()}handleOffer(t,e){let i=new RTCPeerConnection;i.onicecandidate=s=>{this.signalServer.sendMessage(t,{type:"candidate",candidate:s.candidate})},i.ondatachannel=s=>{this.channel.channel=s.channel,this.channel.init()},i.setRemoteDescription(e).then(()=>i.createAnswer()).then(s=>i.setLocalDescription(s)).then(()=>{this.signalServer.sendMessage(t,{type:"answer",answer:i.localDescription})}),this.remoteConnection=i}},T=Object.create(null);T.open="0";T.close="1";T.ping="2";T.pong="3";T.message="4";T.upgrade="5";T.noop="6";var z=Object.create(null);Object.keys(T).forEach(t=>{z[T[t]]=t});var nt={type:"error",data:"parser error"},Vt=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",jt=typeof ArrayBuffer=="function",qt=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,lt=({type:t,data:e},i,s)=>Vt&&e instanceof Blob?i?s(e):wt(e,s):jt&&(e instanceof ArrayBuffer||qt(e))?i?s(e):wt(new Blob([e]),s):s(T[t]+(e||"")),wt=(t,e)=>{let i=new FileReader;return i.onload=function(){let s=i.result.split(",")[1];e("b"+(s||""))},i.readAsDataURL(t)};function xt(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}var tt;function we(t,e){if(Vt&&t.data instanceof Blob)return t.data.arrayBuffer().then(xt).then(e);if(jt&&(t.data instanceof ArrayBuffer||qt(t.data)))return e(xt(t.data));lt(t,!1,i=>{tt||(tt=new TextEncoder),e(tt.encode(i))})}var bt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",M=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let t=0;t<bt.length;t++)M[bt.charCodeAt(t)]=t;var xe=t=>{let e=t.length*.75,i=t.length,s,n=0,r,o,a,h;t[t.length-1]==="="&&(e--,t[t.length-2]==="="&&e--);let c=new ArrayBuffer(e),l=new Uint8Array(c);for(s=0;s<i;s+=4)r=M[t.charCodeAt(s)],o=M[t.charCodeAt(s+1)],a=M[t.charCodeAt(s+2)],h=M[t.charCodeAt(s+3)],l[n++]=r<<2|o>>4,l[n++]=(o&15)<<4|a>>2,l[n++]=(a&3)<<6|h&63;return c},be=typeof ArrayBuffer=="function",dt=(t,e)=>{if(typeof t!="string")return{type:"message",data:zt(t,e)};let i=t.charAt(0);return i==="b"?{type:"message",data:Ce(t.substring(1),e)}:z[i]?t.length>1?{type:z[i],data:t.substring(1)}:{type:z[i]}:nt},Ce=(t,e)=>{if(be){let i=xe(t);return zt(i,e)}else return{base64:!0,data:t}},zt=(t,e)=>{switch(e){case"blob":return t instanceof Blob?t:new Blob([t]);case"arraybuffer":default:return t instanceof ArrayBuffer?t:t.buffer}},Wt="",Re=(t,e)=>{let i=t.length,s=new Array(i),n=0;t.forEach((r,o)=>{lt(r,!1,a=>{s[o]=a,++n===i&&e(s.join(Wt))})})},Ee=(t,e)=>{let i=t.split(Wt),s=[];for(let n=0;n<i.length;n++){let r=dt(i[n],e);if(s.push(r),r.type==="error")break}return s};function Te(){return new TransformStream({transform(t,e){we(t,i=>{let s=i.length,n;if(s<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,s);else if(s<65536){n=new Uint8Array(3);let r=new DataView(n.buffer);r.setUint8(0,126),r.setUint16(1,s)}else{n=new Uint8Array(9);let r=new DataView(n.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(s))}t.data&&typeof t.data!="string"&&(n[0]|=128),e.enqueue(n),e.enqueue(i)})}})}var et;function j(t){return t.reduce((e,i)=>e+i.length,0)}function q(t,e){if(t[0].length===e)return t.shift();let i=new Uint8Array(e),s=0;for(let n=0;n<e;n++)i[n]=t[0][s++],s===t[0].length&&(t.shift(),s=0);return t.length&&s<t[0].length&&(t[0]=t[0].slice(s)),i}function Ae(t,e){et||(et=new TextDecoder);let i=[],s=0,n=-1,r=!1;return new TransformStream({transform(o,a){for(i.push(o);;){if(s===0){if(j(i)<1)break;let h=q(i,1);r=(h[0]&128)===128,n=h[0]&127,n<126?s=3:n===126?s=1:s=2}else if(s===1){if(j(i)<2)break;let h=q(i,2);n=new DataView(h.buffer,h.byteOffset,h.length).getUint16(0),s=3}else if(s===2){if(j(i)<8)break;let h=q(i,8),c=new DataView(h.buffer,h.byteOffset,h.length),l=c.getUint32(0);if(l>Math.pow(2,21)-1){a.enqueue(nt);break}n=l*Math.pow(2,32)+c.getUint32(4),s=3}else{if(j(i)<n)break;let h=q(i,n);a.enqueue(dt(r?h:et.decode(h),e)),s=0}if(n===0||n>t){a.enqueue(nt);break}}}})}var Ht=4;function m(t){if(t)return Se(t)}function Se(t){for(var e in m.prototype)t[e]=m.prototype[e];return t}m.prototype.on=m.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this};m.prototype.once=function(t,e){function i(){this.off(t,i),e.apply(this,arguments)}return i.fn=e,this.on(t,i),this};m.prototype.off=m.prototype.removeListener=m.prototype.removeAllListeners=m.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var i=this._callbacks["$"+t];if(!i)return this;if(arguments.length==1)return delete this._callbacks["$"+t],this;for(var s,n=0;n<i.length;n++)if(s=i[n],s===e||s.fn===e){i.splice(n,1);break}return i.length===0&&delete this._callbacks["$"+t],this};m.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),i=this._callbacks["$"+t],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(i){i=i.slice(0);for(var s=0,n=i.length;s<n;++s)i[s].apply(this,e)}return this};m.prototype.emitReserved=m.prototype.emit;m.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]};m.prototype.hasListeners=function(t){return!!this.listeners(t).length};var Z=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,i)=>i(e,0),C=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),ke="arraybuffer";function Kt(t,...e){return e.reduce((i,s)=>(t.hasOwnProperty(s)&&(i[s]=t[s]),i),{})}var Be=C.setTimeout,Oe=C.clearTimeout;function Q(t,e){e.useNativeTimers?(t.setTimeoutFn=Be.bind(C),t.clearTimeoutFn=Oe.bind(C)):(t.setTimeoutFn=C.setTimeout.bind(C),t.clearTimeoutFn=C.clearTimeout.bind(C))}var Pe=1.33;function Le(t){return typeof t=="string"?Ie(t):Math.ceil((t.byteLength||t.size)*Pe)}function Ie(t){let e=0,i=0;for(let s=0,n=t.length;s<n;s++)e=t.charCodeAt(s),e<128?i+=1:e<2048?i+=2:e<55296||e>=57344?i+=3:(s++,i+=4);return i}function Xt(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function De(t){let e="";for(let i in t)t.hasOwnProperty(i)&&(e.length&&(e+="&"),e+=encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return e}function Me(t){let e={},i=t.split("&");for(let s=0,n=i.length;s<n;s++){let r=i[s].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}var Ne=class extends Error{constructor(t,e,i){super(t),this.description=e,this.context=i,this.type="TransportError"}},ut=class extends m{constructor(t){super(),this.writable=!1,Q(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,i){return super.emitReserved("error",new Ne(t,e,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(t){this.readyState==="open"&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){let e=dt(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){let t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(t){let e=De(t);return e.length?"?"+e:""}},Fe=class extends ut{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";let e=()=>{this.readyState="paused",t()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||e()})),this.writable||(i++,this.once("drain",function(){--i||e()}))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){let e=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};Ee(t,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){let t=()=>{this.write([{type:"close"}])};this.readyState==="open"?t():this.once("open",t)}write(t){this.writable=!1,Re(t,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let t=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=Xt()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(t,e)}},Jt=!1;try{Jt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}var Ue=Jt;function Ve(){}var je=class extends Fe{constructor(t){if(super(t),typeof location<"u"){let e=location.protocol==="https:",i=location.port;i||(i=e?"443":"80"),this.xd=typeof location<"u"&&t.hostname!==location.hostname||i!==t.port}}doWrite(t,e){let i=this.request({method:"POST",data:t});i.on("success",e),i.on("error",(s,n)=>{this.onError("xhr post error",s,n)})}doPoll(){let t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(e,i)=>{this.onError("xhr poll error",e,i)}),this.pollXhr=t}},P=class W extends m{constructor(e,i,s){super(),this.createRequest=e,Q(this,s),this._opts=s,this._method=s.method||"GET",this._uri=i,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var e;let i=Kt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");i.xdomain=!!this._opts.xd;let s=this._xhr=this.createRequest(i);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&s.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var n;s.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=W.requestsCount++,W.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Ve,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete W.requests[this._index],this._xhr=null}}_onLoad(){let e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}};P.requestsCount=0;P.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Ct);else if(typeof addEventListener=="function"){let t="onpagehide"in C?"pagehide":"unload";addEventListener(t,Ct,!1)}}function Ct(){for(let t in P.requests)P.requests.hasOwnProperty(t)&&P.requests[t].abort()}var qe=function(){let t=Yt({xdomain:!1});return t&&t.responseType!==null}(),ze=class extends je{constructor(t){super(t);let e=t&&t.forceBase64;this.supportsBinary=qe&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new P(Yt,this.uri(),t)}};function Yt(t){let e=t.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Ue))return new XMLHttpRequest}catch{}if(!e)try{return new C[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}var Gt=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative",We=class extends ut{get name(){return"websocket"}doOpen(){let t=this.uri(),e=this.opts.protocols,i=Gt?{}:Kt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,i)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){let i=t[e],s=e===t.length-1;lt(i,this.supportsBinary,n=>{try{this.doWrite(i,n)}catch{}s&&Z(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){let t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=Xt()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}},it=C.WebSocket||C.MozWebSocket,He=class extends We{createSocket(t,e,i){return Gt?new it(t,e,i):e?new it(t,e):new it(t)}doWrite(t,e){this.ws.send(e)}},Ke=class extends ut{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then(()=>{this.onClose()}).catch(t=>{this.onError("webtransport error",t)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(t=>{let e=Ae(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=t.readable.pipeThrough(e).getReader(),s=Te();s.readable.pipeTo(t.writable),this._writer=s.writable.getWriter();let n=()=>{i.read().then(({done:o,value:a})=>{o||(this.onPacket(a),n())}).catch(o=>{})};n();let r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(t){this.writable=!1;for(let e=0;e<t.length;e++){let i=t[e],s=e===t.length-1;this._writer.write(i).then(()=>{s&&Z(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var t;(t=this._transport)===null||t===void 0||t.close()}},Xe={websocket:He,webtransport:Ke,polling:ze},Je=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Ye=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function rt(t){if(t.length>8e3)throw"URI too long";let e=t,i=t.indexOf("["),s=t.indexOf("]");i!=-1&&s!=-1&&(t=t.substring(0,i)+t.substring(i,s).replace(/:/g,";")+t.substring(s,t.length));let n=Je.exec(t||""),r={},o=14;for(;o--;)r[Ye[o]]=n[o]||"";return i!=-1&&s!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=Ge(r,r.path),r.queryKey=$e(r,r.query),r}function Ge(t,e){let i=/\/{2,9}/g,s=e.replace(i,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&s.splice(0,1),e.slice(-1)=="/"&&s.splice(s.length-1,1),s}function $e(t,e){let i={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,n,r){n&&(i[n]=r)}),i}var ot=typeof addEventListener=="function"&&typeof removeEventListener=="function",H=[];ot&&addEventListener("offline",()=>{H.forEach(t=>t())},!1);var K=class X extends m{constructor(e,i){if(super(),this.binaryType=ke,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(i=e,e=null),e){let s=rt(e);i.hostname=s.host,i.secure=s.protocol==="https"||s.protocol==="wss",i.port=s.port,s.query&&(i.query=s.query)}else i.host&&(i.hostname=rt(i.host).host);Q(this,i),this.secure=i.secure!=null?i.secure:typeof location<"u"&&location.protocol==="https:",i.hostname&&!i.port&&(i.port=this.secure?"443":"80"),this.hostname=i.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=i.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},i.transports.forEach(s=>{let n=s.prototype.name;this.transports.push(n),this._transportsByName[n]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},i),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Me(this.opts.query)),ot&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},H.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){let i=Object.assign({},this.opts.query);i.EIO=Ht,i.transport=e,this.id&&(i.sid=this.id);let s=Object.assign({},this.opts,{query:i,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}let e=this.opts.rememberUpgrade&&X.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";let i=this.createTransport(e);i.open(),this.setTransport(i)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",i=>this._onClose("transport close",i))}onOpen(){this.readyState="open",X.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":let i=new Error("server error");i.code=e.data,this._onError(i);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);let e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){let e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let i=1;for(let s=0;s<this.writeBuffer.length;s++){let n=this.writeBuffer[s].data;if(n&&(i+=Le(n)),s>0&&i>this._maxPayload)return this.writeBuffer.slice(0,s);i+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;let e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Z(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,i,s){return this._sendPacket("message",e,i,s),this}send(e,i,s){return this._sendPacket("message",e,i,s),this}_sendPacket(e,i,s,n){if(typeof i=="function"&&(n=i,i=void 0),typeof s=="function"&&(n=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;let r={type:e,data:i,options:s};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),n&&this.once("flush",n),this.flush()}close(){let e=()=>{this._onClose("forced close"),this.transport.close()},i=()=>{this.off("upgrade",i),this.off("upgradeError",i),e()},s=()=>{this.once("upgrade",i),this.once("upgradeError",i)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():e()}):this.upgrading?s():e()),this}_onError(e){if(X.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,i){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),ot&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){let s=H.indexOf(this._offlineEventListener);s!==-1&&H.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,i),this.writeBuffer=[],this._prevBufferLen=0}}};K.protocol=Ht;var Ze=class extends K{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}_probe(t){let e=this.createTransport(t),i=!1;K.priorWebsocketSuccess=!1;let s=()=>{i||(e.send([{type:"ping",data:"probe"}]),e.once("packet",l=>{if(!i)if(l.type==="pong"&&l.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;K.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(c(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{let u=new Error("probe error");u.transport=e.name,this.emitReserved("upgradeError",u)}}))};function n(){i||(i=!0,c(),e.close(),e=null)}let r=l=>{let u=new Error("probe error: "+l);u.transport=e.name,n(),this.emitReserved("upgradeError",u)};function o(){r("transport closed")}function a(){r("socket closed")}function h(l){e&&l.name!==e.name&&n()}let c=()=>{e.removeListener("open",s),e.removeListener("error",r),e.removeListener("close",o),this.off("close",a),this.off("upgrading",h)};e.once("open",s),e.once("error",r),e.once("close",o),this.once("close",a),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"?this.setTimeoutFn(()=>{i||e.open()},200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){let e=[];for(let i=0;i<t.length;i++)~this.transports.indexOf(t[i])&&e.push(t[i]);return e}},$t=class extends Ze{constructor(t,e={}){let i=typeof t=="object"?t:e;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(s=>Xe[s]).filter(s=>!!s)),super(t,i)}},Ci=$t.protocol;function Qe(t,e="",i){let s=t;i=i||typeof location<"u"&&location,t==null&&(t=i.protocol+"//"+i.host),typeof t=="string"&&(t.charAt(0)==="/"&&(t.charAt(1)==="/"?t=i.protocol+t:t=i.host+t),/^(https?|wss?):\/\//.test(t)||(typeof i<"u"?t=i.protocol+"//"+t:t="https://"+t),s=rt(t)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";let r=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+r+":"+s.port+e,s.href=s.protocol+"://"+r+(i&&i.port===s.port?"":":"+s.port),s}var Zt={};B(Zt,{Decoder:()=>ci,Encoder:()=>hi,PacketType:()=>p,protocol:()=>ai});var ti=typeof ArrayBuffer=="function",ei=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,Qt=Object.prototype.toString,ii=typeof Blob=="function"||typeof Blob<"u"&&Qt.call(Blob)==="[object BlobConstructor]",si=typeof File=="function"||typeof File<"u"&&Qt.call(File)==="[object FileConstructor]";function pt(t){return ti&&(t instanceof ArrayBuffer||ei(t))||ii&&t instanceof Blob||si&&t instanceof File}function J(t,e){if(!t||typeof t!="object")return!1;if(Array.isArray(t)){for(let i=0,s=t.length;i<s;i++)if(J(t[i]))return!0;return!1}if(pt(t))return!0;if(t.toJSON&&typeof t.toJSON=="function"&&arguments.length===1)return J(t.toJSON(),!0);for(let i in t)if(Object.prototype.hasOwnProperty.call(t,i)&&J(t[i]))return!0;return!1}function ni(t){let e=[],i=t.data,s=t;return s.data=at(i,e),s.attachments=e.length,{packet:s,buffers:e}}function at(t,e){if(!t)return t;if(pt(t)){let i={_placeholder:!0,num:e.length};return e.push(t),i}else if(Array.isArray(t)){let i=new Array(t.length);for(let s=0;s<t.length;s++)i[s]=at(t[s],e);return i}else if(typeof t=="object"&&!(t instanceof Date)){let i={};for(let s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=at(t[s],e));return i}return t}function ri(t,e){return t.data=ht(t.data,e),delete t.attachments,t}function ht(t,e){if(!t)return t;if(t&&t._placeholder===!0){if(typeof t.num=="number"&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}else if(Array.isArray(t))for(let i=0;i<t.length;i++)t[i]=ht(t[i],e);else if(typeof t=="object")for(let i in t)Object.prototype.hasOwnProperty.call(t,i)&&(t[i]=ht(t[i],e));return t}var oi=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],ai=5,p;(function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"})(p||(p={}));var hi=class{constructor(t){this.replacer=t}encode(t){return(t.type===p.EVENT||t.type===p.ACK)&&J(t)?this.encodeAsBinary({type:t.type===p.EVENT?p.BINARY_EVENT:p.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id}):[this.encodeAsString(t)]}encodeAsString(t){let e=""+t.type;return(t.type===p.BINARY_EVENT||t.type===p.BINARY_ACK)&&(e+=t.attachments+"-"),t.nsp&&t.nsp!=="/"&&(e+=t.nsp+","),t.id!=null&&(e+=t.id),t.data!=null&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){let e=ni(t),i=this.encodeAsString(e.packet),s=e.buffers;return s.unshift(i),s}};function Rt(t){return Object.prototype.toString.call(t)==="[object Object]"}var ci=class te extends m{constructor(e){super(),this.reviver=e}add(e){let i;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");i=this.decodeString(e);let s=i.type===p.BINARY_EVENT;s||i.type===p.BINARY_ACK?(i.type=s?p.EVENT:p.ACK,this.reconstructor=new li(i),i.attachments===0&&super.emitReserved("decoded",i)):super.emitReserved("decoded",i)}else if(pt(e)||e.base64)if(this.reconstructor)i=this.reconstructor.takeBinaryData(e),i&&(this.reconstructor=null,super.emitReserved("decoded",i));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let i=0,s={type:Number(e.charAt(0))};if(p[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===p.BINARY_EVENT||s.type===p.BINARY_ACK){let r=i+1;for(;e.charAt(++i)!=="-"&&i!=e.length;);let o=e.substring(r,i);if(o!=Number(o)||e.charAt(i)!=="-")throw new Error("Illegal attachments");s.attachments=Number(o)}if(e.charAt(i+1)==="/"){let r=i+1;for(;++i&&!(e.charAt(i)===","||i===e.length););s.nsp=e.substring(r,i)}else s.nsp="/";let n=e.charAt(i+1);if(n!==""&&Number(n)==n){let r=i+1;for(;++i;){let o=e.charAt(i);if(o==null||Number(o)!=o){--i;break}if(i===e.length)break}s.id=Number(e.substring(r,i+1))}if(e.charAt(++i)){let r=this.tryParse(e.substr(i));if(te.isPayloadValid(s.type,r))s.data=r;else throw new Error("invalid payload")}return s}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,i){switch(e){case p.CONNECT:return Rt(i);case p.DISCONNECT:return i===void 0;case p.CONNECT_ERROR:return typeof i=="string"||Rt(i);case p.EVENT:case p.BINARY_EVENT:return Array.isArray(i)&&(typeof i[0]=="number"||typeof i[0]=="string"&&oi.indexOf(i[0])===-1);case p.ACK:case p.BINARY_ACK:return Array.isArray(i)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}},li=class{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){let e=ri(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}};function E(t,e,i){return t.on(e,i),function(){t.off(e,i)}}var di=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1}),ee=class extends m{constructor(t,e,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;let t=this.io;this.subs=[E(t,"open",this.onopen.bind(this)),E(t,"packet",this.onpacket.bind(this)),E(t,"error",this.onerror.bind(this)),E(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var i,s,n;if(di.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;let r={type:p.EVENT,data:e};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){let c=this.ids++,l=e.pop();this._registerAckCallback(c,l),r.id=c}let o=(s=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||s===void 0?void 0:s.writable,a=this.connected&&!(!((n=this.io.engine)===null||n===void 0)&&n._hasPingExpired());return this.flags.volatile&&!o||(a?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(t,e){var i;let s=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(s===void 0){this.acks[t]=e;return}let n=this.io.setTimeoutFn(()=>{delete this.acks[t];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===t&&this.sendBuffer.splice(o,1);e.call(this,new Error("operation has timed out"))},s),r=(...o)=>{this.io.clearTimeoutFn(n),e.apply(this,o)};r.withError=!0,this.acks[t]=r}emitWithAck(t,...e){return new Promise((i,s)=>{let n=(r,o)=>r?s(r):i(o);n.withError=!0,e.push(n),this.emit(t,...e)})}_addToQueue(t){let e;typeof t[t.length-1]=="function"&&(e=t.pop());let i={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push((s,...n)=>i!==this._queue[0]?void 0:(s!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(s)):(this._queue.shift(),e&&e(null,...n)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||this._queue.length===0)return;let e=this._queue[0];e.pending&&!t||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){typeof this.auth=="function"?this.auth(t=>{this._sendConnectPacket(t)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:p.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(t=>{if(!this.sendBuffer.some(i=>String(i.id)===t)){let i=this.acks[t];delete this.acks[t],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case p.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case p.EVENT:case p.BINARY_EVENT:this.onevent(t);break;case p.ACK:case p.BINARY_ACK:this.onack(t);break;case p.DISCONNECT:this.ondisconnect();break;case p.CONNECT_ERROR:this.destroy();let i=new Error(t.data.message);i.data=t.data.data,this.emitReserved("connect_error",i);break}}onevent(t){let e=t.data||[];t.id!=null&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){let e=this._anyListeners.slice();for(let i of e)i.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&typeof t[t.length-1]=="string"&&(this._lastOffset=t[t.length-1])}ack(t){let e=this,i=!1;return function(...s){i||(i=!0,e.packet({type:p.ACK,id:t,data:s}))}}onack(t){let e=this.acks[t.id];typeof e=="function"&&(delete this.acks[t.id],e.withError&&t.data.unshift(null),e.apply(this,t.data))}onconnect(t,e){this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(t=>this.emitEvent(t)),this.receiveBuffer=[],this.sendBuffer.forEach(t=>{this.notifyOutgoingListeners(t),this.packet(t)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(t=>t()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:p.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){let e=this._anyListeners;for(let i=0;i<e.length;i++)if(t===e[i])return e.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){let e=this._anyOutgoingListeners;for(let i=0;i<e.length;i++)if(t===e[i])return e.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){let e=this._anyOutgoingListeners.slice();for(let i of e)i.apply(this,t.data)}}};function L(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}L.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),i=Math.floor(e*this.jitter*t);t=(Math.floor(e*10)&1)==0?t-i:t+i}return Math.min(t,this.max)|0};L.prototype.reset=function(){this.attempts=0};L.prototype.setMin=function(t){this.ms=t};L.prototype.setMax=function(t){this.max=t};L.prototype.setJitter=function(t){this.jitter=t};var ct=class extends m{constructor(t,e){var i;super(),this.nsps={},this.subs=[],t&&typeof t=="object"&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,Q(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((i=e.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new L({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=t;let s=e.parser||Zt;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return t===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return t===void 0?this._reconnectionDelay:(this._reconnectionDelay=t,(e=this.backoff)===null||e===void 0||e.setMin(t),this)}randomizationFactor(t){var e;return t===void 0?this._randomizationFactor:(this._randomizationFactor=t,(e=this.backoff)===null||e===void 0||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return t===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,(e=this.backoff)===null||e===void 0||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new $t(this.uri,this.opts);let e=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;let s=E(e,"open",function(){i.onopen(),t&&t()}),n=o=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",o),t?t(o):this.maybeReconnectOnOpen()},r=E(e,"error",n);if(this._timeout!==!1){let o=this._timeout,a=this.setTimeoutFn(()=>{s(),n(new Error("timeout")),e.close()},o);this.opts.autoUnref&&a.unref(),this.subs.push(()=>{this.clearTimeoutFn(a)})}return this.subs.push(s),this.subs.push(r),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");let t=this.engine;this.subs.push(E(t,"ping",this.onping.bind(this)),E(t,"data",this.ondata.bind(this)),E(t,"error",this.onerror.bind(this)),E(t,"close",this.onclose.bind(this)),E(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(e){this.onclose("parse error",e)}}ondecoded(t){Z(()=>{this.emitReserved("packet",t)},this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let i=this.nsps[t];return i?this._autoConnect&&!i.active&&i.connect():(i=new ee(this,t,e),this.nsps[t]=i),i}_destroy(t){let e=Object.keys(this.nsps);for(let i of e)if(this.nsps[i].active)return;this._close()}_packet(t){let e=this.encoder.encode(t);for(let i=0;i<e.length;i++)this.engine.write(e[i],t.options)}cleanup(){this.subs.forEach(t=>t()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;let t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{let e=this.backoff.duration();this._reconnecting=!0;let i=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),!t.skipReconnect&&t.open(s=>{s?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",s)):t.onreconnect()}))},e);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){let t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}},I={};function Y(t,e){typeof t=="object"&&(e=t,t=void 0),e=e||{};let i=Qe(t,e.path||"/socket.io"),s=i.source,n=i.id,r=i.path,o=I[n]&&r in I[n].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o,h;return a?h=new ct(s,e):(I[n]||(I[n]=new ct(s,e)),h=I[n]),i.query&&!e.query&&(e.query=i.queryKey),h.socket(i.path,e)}Object.assign(Y,{Manager:ct,Socket:ee,io:Y,connect:Y});var ie=class{params;socket;connected;rooms;onMessage;onConnect;onDisconnect;onJoinRoom;onLeaveRoom;constructor(t){this.params=t,this.connected=!1,this.rooms=new Set}start(){this.socket=Y(this.params.host),this.socket.on("connect",()=>{this.connected=!0,this.onConnect&&this.onConnect()}),this.socket.on("message",t=>{this.onMessage&&this.onMessage(t.target,t.data.message)}),this.socket.on("join-room",t=>{t.target==this.socket.id&&this.rooms.add(t.data.room),this.onJoinRoom&&this.onJoinRoom(t.target,t.data.room)}),this.socket.on("leave-room",t=>{t.target==this.socket.id&&this.rooms.delete(t.data.room),this.onLeaveRoom&&this.onLeaveRoom(t.target,t.data.room)}),this.socket.on("disconnect",()=>{this.connected=!1,this.onDisconnect&&this.onDisconnect()})}sendMessage(t,e){this.socket.emit("message",{emitType:"single",message:e,to:t})}broadcastMessage(t,e=[]){this.socket.emit("message",{emitType:"broadcast",message:t,rooms:e})}joinRoom(t){this.socket.emit("room",{action:"join",room:t})}leaveRoom(t){this.socket.emit("room",{action:"leave",room:t})}},ui=class extends S{_refreshRate;_channelClient;_interval;constructor(t){super(),this._refreshRate=t.refreshRate??1e3/30,this._channelClient=new ve(new ie({host:t.host}))}start(){this._channelClient.onConnect=()=>{this.broadcast({topic:"connect"})},this._channelClient.onDisconnect=()=>{this.broadcast({topic:"disconnect"})},this._channelClient.onMessage=(t,e)=>{switch(e=JSON.parse(e),e.type){case"data":this.broadcast({topic:"data",data:e.data});break;case"join":this.broadcast({topic:"join",socketId:e.socketId});break;case"leave":this.broadcast({topic:"leave",socketId:e.socketId});break}},this._interval=setInterval(()=>this._updateEntity(),this._refreshRate),this._channelClient.connect()}destroy(){this._interval&&clearInterval(this._interval)}_updateEntity(){this._channelClient.channel.ready&&this._channelClient.channel.send(this._entity.getComponent("Serializer").serialize())}},pi=class{socketId;server;localConnection;channel;constructor(t,e){this.socketId=t,this.server=e,this.localConnection=new RTCPeerConnection,this.localConnection.onicecandidate=s=>{e.signalServer.sendMessage(t,{type:"candidte",candidate:s.candidate})};let i=this.localConnection.createDataChannel("main");this.channel=new Ut(i),this.channel.init(),this.channel.onConnect=()=>{e.onConnect&&e.onConnect(this)},this.channel.onDisconnect=()=>{e.removeConnection(this),e.onDisconnect&&e.onDisconnect(this)},this.channel.onMessage=s=>{e.onMessage&&e.onMessage(this,s)},this.localConnection.createOffer().then(s=>this.localConnection.setLocalDescription(s)).then(()=>{e.signalServer.sendMessage(t,{type:"offer",offer:this.localConnection.localDescription})})}handleSignalMessage(t){switch(t.type){case"answer":this.localConnection.setRemoteDescription(t.answer);break;case"candidate":this.localConnection.addIceCandidate(t.candidate);break}}get connected(){return this.channel.ready}},fi=class{serverRoom;signalServer;connections;onStart;onConnect;onDisconnect;onMessage;constructor(t,e){this.serverRoom=t,this.signalServer=e,this.connections=[],e.onConnect=()=>{e.joinRoom(t),this.onStart&&this.onStart()},e.onJoinRoom=(i,s)=>{e.socket.id==i||s!=this.serverRoom||this.createConnection(i)},e.onLeaveRoom=(i,s)=>{if(e.socket.id==i||s!=this.serverRoom)return;let n=this.connections.find(r=>r.socketId==i);n&&n.localConnection.close()},e.onMessage=(i,s)=>{let n=this.connections.find(r=>r.socketId==i);n&&n.handleSignalMessage(s)}}connect(){this.signalServer.start()}createConnection(t){let e=new pi(t,this);this.connections.push(e)}removeConnection(t){this.connections.splice(this.connections.indexOf(t),1)}},_i=class extends S{_running;_refreshRate;_channelServer;_interval;_entityData;constructor(t){super(),this._refreshRate=t.refreshRate??1e3/30,this._entityData=[],this._running=!1,this._channelServer=new fi(t.room,new ie({host:t.host}))}start(){this._channelServer.onStart=()=>{this._running=!0,console.log("Channel server is running")},this._channelServer.onConnect=t=>{let e={socketId:t.socketId};this._entityData.push(e),this._sendTextDataToAll({type:"join",socketId:t.socketId})},this._channelServer.onDisconnect=t=>{let e=this._entityData.find(i=>i.socketId==t.socketId);this._entityData.splice(this._entityData.indexOf(e),1),this._sendTextDataToAll({type:"leave",socketId:t.socketId})},this._channelServer.onMessage=(t,e)=>{let i=this._entityData.find(s=>s.socketId==t.socketId);i&&(i.data=JSON.parse(e))},this._channelServer.connect(),this._interval=setInterval(()=>{this._updateEntities()},this._refreshRate)}destroy(){this._running=!1,this._interval&&clearInterval(this._interval)}_updateEntities(){this._running&&this._sendTextDataToAll({type:"data",data:this._entityData})}_sendTextData(t,e){t.channel.send(JSON.stringify(e))}_sendTextDataToAll(t){for(let e of this._channelServer.connections)e.connected&&this._sendTextData(e,t)}},gi=class extends S{constructor(){super(),this._parent=null,this._children=new Set,this._position=new k,this._scale=new k(1,1)}get position(){return this._position}set position(t){this._position.copy(t)}get scale(){return this._scale}set scale(t){this._scale.copy(t)}getWorldPosition(){return this._parent?this._parent.getWorldPosition().add(this._position):this._position.clone()}setParent(t){this._parent&&this._position.add(this._parent.getWorldPosition()),t&&this._position.sub(t.getWorldPosition()),this._parent=t}},mi=class se{static _ids=0;static genName(){return"_entity_"+this._ids++}constructor(e){typeof e>"u"?this._name=se.genName():this._name=e,this._groups=new Set,this._componentsMap=new Map,this._components=[],this._scene=null,this._transform=new gi,this._handlers={},this.addComponent("Transform",this._transform)}get name(){return this._name}get groups(){return this._groups}get transform(){return this._transform}addComponent(e,i){return i._entity=this,this._componentsMap.set(e,i),this._components.push(i),i}getComponent(e){return this._componentsMap.get(e)}start(){for(let e=0;e<this._components.length;++e)this._components[e].start()}update(e){for(let i=0;i<this._components.length;++i)this._components[i].update(e)}destroy(){for(let e=0;e<this._components.length;++e)this._components[e].destroy()}registerHandler(e,i){e in this._handlers||(this._handlers[e]=[]),this._handlers[e].push(i)}broadcast(e){if(e.topic in this._handlers)for(let i of this._handlers[e.topic])i(e)}},yi=class{constructor(){this._entities=[],this._entityMap=new Map}add(t){this._entities.push(t),this._entityMap.set(t.name,t)}get(t){return this._entityMap.get(t)}remove(t){let e=this._entities.indexOf(t);this._entities.splice(e,1),this._entityMap.delete(t.name)}},vi=function(){class t extends S{constructor(i){super(),this._viewport=i.viewport,this._wcWidth=i.wcWidth,this._projectionM=O.create(),this._viewM=O.create(),this._projectionViewM=O.create()}get viewport(){return this._viewport}set viewport(i){this._viewport=i}get projection(){return this._projectionM}get view(){return this._viewM}get projectionView(){return this._projectionViewM}getBoundingRect(){let i=this._wcWidth/this._entity.transform.scale.x,s=this._getWCHeight()/this._entity.transform.scale.y,n=this._entity.transform.position;return{x:n.x-i/2,y:n.y-s/2,width:i,height:s}}update(){let i=this._wcWidth*.5/this._entity.transform.scale.x,s=this._getWCHeight()*.5/this._entity.transform.scale.y;O.ortho(this._projectionM,-i,i,s,-s,0,100),this._viewM[12]=-this._entity.transform.position.x,this._viewM[13]=-this._entity.transform.position.y,O.multiply(this._projectionViewM,this._projectionM,this._viewM)}begin(i){let s=this._viewport[0],n=i.canvas.height-this._viewport[3]-this._viewport[1],r=this._viewport[2],o=this._viewport[3];i.viewport(s,n,r,o)}_getWCHeight(){return this._wcWidth*this._viewport[3]/this._viewport[2]}}return{Camera:t}}(),wi=class{_renderer;constructor(){this._started=!1,this._entityManager=new yi,this._pendingEntities=[],this._entitiesToRemove=[],this._camera={}}get camera(){return this._camera}get renderer(){return this._renderer}init(){}createEntity(t){let e=new mi(t);return this._started?this._pendingEntities.push(e):(this._entityManager.add(e),e._scene=this),e}removeEntity(t){this._started?this._entitiesToRemove.push(t):this._entityManager.remove(t)}getEntitiesByGroup(t){return this._entityManager._entities.filter(e=>e.groups.has(t))}getEntityByName(t){return this._entityManager.get(t)}createCamera(t,e){let i=this._camera[t]=new vi.Camera(e),s=this.createEntity();return s.addComponent("camera",i),s.groups.add("camera"),i}start(){this._renderer.start();for(let t=0;t<this._entityManager._entities.length;++t)this._entityManager._entities[t].start();this._started=!0}update(t){for(let e=0;e<this._entityManager._entities.length;++e)this._entityManager._entities[e].update(t);for(;this._pendingEntities.length>0;){let e=this._pendingEntities.pop();this._entityManager.add(e),e._scene=this,e.start()}for(;this._entitiesToRemove.length>0;){let e=this._entitiesToRemove.pop();e.destroy(),this._entityManager.remove(e)}}render(){for(let t in this._camera)this._camera[t].update();this._renderer.render()}destroy(){for(let t=0;t<this._entityManager._entities.length;++t)this._entityManager._entities[t].destroy();this._started=!1}},d=function(){class t{static _instance=null;_config;_canvas;_lastRAF;_dt;_accTime;_fpsCounter;_fps;_scene;constructor(){this._lastRAF=void 0,this._dt=0,this._accTime=0,this._fpsCounter=0,this._fps=0,this._scene=null}static get config(){return this._get()._config}static _get(){return this._instance==null&&(this._instance=new t),this._instance}static async init(i){let s=this._get();s._config=i,s._canvas=new Ot.GLCanvas,i.container.appendChild(s._canvas.domElement),s._canvas.setViewportMode(i.viewportMode),s._canvas.setSize(i.width,i.height),s._canvas.start(),st._get().start(),await i.preload(),this.changeScene(i.scene,i.sceneParams),s._RAF()}static changeScene(i,s){let n=this._get();n._scene&&n._scene.destroy(),i._renderer=new Pt.Renderer(n._canvas.context),i.createCamera("main",{viewport:[0,0,n._config.width,n._config.height],wcWidth:n._config.width}),i.init(s),i.start(),n._scene=i}update(){st._get().update();for(let i of $.AssetsManager._textures.values())i.update(this._dt);this._scene.update(this._dt)}render(){let i=this._canvas.context;i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this._scene.renderer.render()}_RAF(){requestAnimationFrame(i=>{this._RAF(),i*=.001,this._dt=i-(this._lastRAF||i),this._dt=Math.min(this._dt,1/20),this._lastRAF=i,this._accTime+=this._dt,++this._fpsCounter,this._accTime>=1&&(this._accTime=0,this._fps=this._fpsCounter,this._fpsCounter=0),this.update(),this.render()})}}return{Lancelot:t,Scene:wi,Component:S,graphics:Et,utils:Lt,math:It,input:Dt,geometry:Nt,network:Ft}}();var{AssetsManager:A,loadImage:ft}=d.utils.assets,{Vector:R}=d.math,{ChannelServerController:xi,ChannelClientController:bi}=d.network,f=16,ne="GrottoTest",re="https://grotto-online.onrender.com",oe=1e3/60,_t=class extends d.Component{serialize(){let e=this.getComponent("controller"),i={};return i.position=this._entity.transform.position,i.velocity=e._velocity,i.grounded=e._grounded,i.climbing=e._climbing,i.input=e._input,JSON.stringify(i)}},gt=class extends d.Component{constructor(){super(),this._velocity=new R,this._grounded=!1,this._climbing=!1,this._slopes=[]}updatePhysics(e){let i=this._velocity.clone().scale(e);this._grounded=!1,this._entity.transform.position.x+=i.x;let s=this.getComponent("collider"),n;s.setPosition(this._entity.transform.position);let r=s.shape,o=s.shape.clone();if(this._slopes.length)for(let a of this._slopes)this._updateSlope(a);else{n=this._getTiles(new R(r.getLeft(),r.getTop()),new R(r.getRight(),r.getBottom())),n=n.filter(a=>a.tile&&a.tile.getProperty("collide"));for(let a of n)this._collide(a,i.x<0?"l":"r",o)}this._entity.transform.position.y+=i.y,s.setPosition(this._entity.transform.position),n=this._getTiles(new R(r.getLeft(),r.getTop()),new R(r.getRight(),r.getBottom())),n=n.filter(a=>a.tile&&(a.tile.getProperty("collide")||this._isTopLedder(a)&&!this._climbing));for(let a of n)this._collide(a,i.y<0?"u":"d",o)}_isTopLedder(e){let s=this._entity._scene.getEntityByName("levelMap").getComponent("tilemap").tilemap.getLayerByName("midground").getTile(e.x,e.y-1);return e.tile.getProperty("ledder")&&(!s||s.tile&&s.tile.getProperty("ledder")==!1)}_getTiles(e,i){let s=[],n=this._entity._scene.getEntityByName("levelMap").getComponent("tilemap"),r=~~(e.x/n.tilemap.tilewidth),o=~~(i.x/n.tilemap.tilewidth),a=~~(e.y/n.tilemap.tileheight),h=~~(i.y/n.tilemap.tileheight),l=n.tilemap.getLayers().find(u=>u.name=="midground");for(let u=r;u<=o;++u)for(let _=a;_<=h;++_)s.push({tile:l.getTile(u,_),x:u,y:_});return s}_updateSlope(e){let s=this.getComponent("collider").shape,n=(e.y+1-e.tile.getProperty("y1"))*f,r=(e.y+1-e.tile.getProperty("y2"))*f,o=e.x*f,a=(e.x+1)*f;if((s.getLeft()>a||s.getRight()<o)&&(s.getBottom()>=Math.max(n,r)||s.getBottom()<=Math.min(n,r))){let l=this._slopes.indexOf(e);this._slopes.splice(l,1);return}let h=n<r?s.getLeft():s.getRight(),c=d.math.math.map(n,r,o,a,d.math.math.clamp(h,o,a));this._entity.transform.position.y=c-s.height/2,s.getBottom()>c&&(this._grounded=!0,this._entity.transform.position.y=c-s.height/2,this._velocity.y=0)}_collide(e,i,s){let n=this.getComponent("collider"),r=n.shape,o=new d.geometry.shape.Rect(f,f);if(o.setPosition((e.x+.5)*f,(e.y+.5)*f),!!r.intersects(o)){if(e.tile.getProperty("slope")){if(i!="d")return;let h=this.getComponent("collider").shape,c=(e.y+1-e.tile.getProperty("y1"))*f,l=(e.y+1-e.tile.getProperty("y2"))*f,u=e.x*f,_=(e.x+1)*f,g=c<l?h.getLeft():h.getRight(),b=d.math.math.map(c,l,u,_,d.math.math.clamp(g,u,_));(h.getBottom()>b||this._slopes.length)&&(this._grounded=!0,this._slopes.push(e),h.getBottom()>b&&(this._entity.transform.position.y=b-h.height/2,this._velocity.y=0))}else switch(i){case"l":r.getLeft()<o.getRight()&&(this._entity.transform.position.x=o.getRight()+r.width/2,this._velocity.x=0);break;case"r":r.getRight()>o.getLeft()&&(this._entity.transform.position.x=o.getLeft()-r.width/2,this._velocity.x=0);break;case"u":!e.tile.getProperty("ledder")&&r.getTop()<o.getBottom()&&(this._entity.transform.position.y=o.getBottom()+r.height/2,this._velocity.y=0);break;case"d":r.getBottom()>o.getTop()&&(!e.tile.getProperty("ledder")||s.getBottom()<=o.getTop())&&(this._grounded=!0,this._entity.transform.position.y=o.getTop()-r.height/2,this._velocity.y=0);break}n.setPosition(this._entity.transform.position)}}},mt=class extends gt{constructor(e){super(),this._maxSpeed=80,this._acceleration=300,this._jumpForce=95,this._climbingSpeed=40,this._gravity=180,this._idleClimbing=!1,this._moving=!1,this._input={left:!1,right:!1,jump:!1,up:!1,down:!1},this._ledders=[],this._justClimbed=0,this._remote=e.remote??!1,this._roomCreated=!1}start(){this.getComponent("sprite").playAnim(d.graphics.Animations.get("player.idle"),!0)}update(e){this._remote||this._updateInput(),this._moving=!1,this._justClimbed>0&&--this._justClimbed,!(this._input.up||this._input.down)&&this._input.jump&&(this._grounded||this._climbing)&&(this._grounded=!1,this._climbing=!1,this._slopes=[],this._velocity.y=-this._jumpForce*(Math.abs(this._velocity.x/this._maxSpeed)*.1+1));let i=this.getComponent("collider");i.setPosition(this._entity.transform.position);let s=i.shape;if(this._climbing){this._idleClimbing=!0;let n=1/0;this._ledders.forEach(r=>{let o=new d.geometry.shape.Rect(f,f);return o.setPosition((r.x+.5)*f,(r.y+.5)*f),n>o.getTop()&&(n=o.getTop()),s.intersects(o)}),this._ledders=this._getTiles(new R(s.getLeft()+s.width/2,s.getTop()),new R(s.getRight()-s.width/2,s.getBottom())).filter(r=>(new d.geometry.shape.Rect(f,f).setPosition((r.x+.5)*16,(r.y+.5)*f),r.tile&&r.tile.getProperty("ledder"))),(this._input.left||this._input.right)&&!(this._input.up||this._input.down)||!this._ledders.length?(this._climbing=!1,this._velocity.y=0,this._input.up&&!this._ledders.length&&(this._entity.transform.position.y=n-s.height/2,this._justClimbed=2)):this._input.up?(this._idleClimbing=!1,this._velocity.y=-this._climbingSpeed):this._input.down?(this._idleClimbing=!1,this._velocity.y=this._climbingSpeed,this._grounded&&(this._climbing=!1)):this._velocity.y=0}else{if(this._input.left?(this._moving=!0,this._velocity.x-=this._acceleration*e):this._input.right&&(this._moving=!0,this._velocity.x+=this._acceleration*e),this._input.up||this._input.down){let n=this._getTiles(new R(s.getLeft()+s.width/2,s.getTop()),new R(s.getRight()-s.width/2,s.getBottom()));this._ledders=n.filter(r=>{let o=new d.geometry.shape.Rect(f,f);return o.setPosition((r.x+.5)*16,(r.y+.5)*f),r.tile&&r.tile.getProperty("ledder")&&(this._input.up&&o.getTop()<s.getBottom()||this._input.down&&o.getBottom()>s.getBottom())}),this._ledders.length&&(this._climbing=!0,this._velocity.x=0,this._entity.transform.position.x=(this._ledders[0].x+.5)*f)}this._moving||(this._velocity.x-=this._velocity.x*Math.min((this._grounded?10:2.5)*e,1)),Math.abs(this._velocity.x)>this._maxSpeed&&(this._velocity.x=Math.sign(this._velocity.x)*this._maxSpeed),this._velocity.y+=this._gravity*e}this._updateSprite(),this.updatePhysics(e)}_updateSprite(){let e=this.getComponent("sprite");this._climbing||this._justClimbed>0?(e.isAnimPlaying("player.climb")||e.playAnim(d.graphics.Animations.get("player.climb"),!0),this._idleClimbing?e.pauseAnim():e.resumeAnim()):(this._input.left?this._entity.transform.scale.x=-1:this._input.right&&(this._entity.transform.scale.x=1),this._grounded?this._moving?e.isAnimPlaying("player.run")||e.playAnim(d.graphics.Animations.get("player.run"),!0):e.isAnimPlaying("player.idle")||e.playAnim(d.graphics.Animations.get("player.idle"),!0):e.isAnimPlaying("player.jump")||e.playAnim(d.graphics.Animations.get("player.jump"),!0))}_updateInput(){!this._roomCreated&&d.input.KeyListener.isPressed("KeyK")&&this._createRoom(),d.input.KeyListener.isPressed("KeyJ")&&this._joinRoom(),d.input.KeyListener.isPressed("KeyL")&&this._leaveRoom(),this._input.left=d.input.KeyListener.isDown("KeyA"),this._input.right=d.input.KeyListener.isDown("KeyD"),this._input.up=d.input.KeyListener.isDown("KeyW"),this._input.down=d.input.KeyListener.isDown("KeyS"),this._input.jump=d.input.KeyListener.isPressed("Space")}_joinRoom(){this.getComponent("client")._channelClient.joinRoom(ne)}_leaveRoom(){this.getComponent("client")._channelClient.leaveRoom()}_createRoom(){this._entity._scene.createEntity("server").addComponent("server",new xi({room:ne,host:re,refreshRate:oe})),this._roomCreated=!0}},yt=class extends d.Component{update(e){let i=this._entity._scene.getEntityByName("player");this._entity.transform.position.lerp(i.transform.position,Math.min(e*4,1));let s=this._entity._scene.getEntityByName("levelMap").getComponent("tilemap"),r=this._entity.getComponent("camera").getBoundingRect();r.x+r.width>s.tilemap.width*s.tilemap.tilewidth?this._entity.transform.position.x=s.tilemap.width*s.tilemap.tilewidth-r.width/2:r.x<0&&(this._entity.transform.position.x=r.width/2),r.y+r.height>s.tilemap.height*s.tilemap.tileheight?this._entity.transform.position.y=s.tilemap.height*s.tilemap.tileheight-r.height/2:r.y<0&&(this._entity.transform.position.y=r.height/2)}},vt=class extends d.Scene{init(){this.remotePlayers=[],this.camera.main._entity.addComponent("controller",new yt),this.camera.main._entity.transform.scale.set(4,4);let e=d.utils.Store.get("tilemap"),i=this.createEntity("levelMap");i.addComponent("tilemap",new d.graphics.OrthogonalMap(e)),i.addComponent("tilemapRenderer",new d.graphics.OrthogonalMapRenderer({tilemap:e,tilesets:{bat:A.getImage("bat"),"environment-tiles":A.getImage("tileset")},camera:this.camera.main})),i.registerHandler("tilemapObject",s=>{let n=s.object;switch(n.name){case"player":{let r=this.createPlayer(!1,s.layer.zIndex);this.player=r,r.transform.position.set(n.x,n.y),r.addComponent("Serializer",new _t),r.addComponent("client",new bi({host:re,refreshRate:oe})),r.registerHandler("connect",()=>{this.onPlayerConnect()}),r.registerHandler("disconnect",()=>{this.onPlayerDisconnect()}),r.registerHandler("data",o=>{this.onPlayerData(o.data)}),r.registerHandler("join",o=>{if(o.socketId==r.getComponent("controller").socketId)return;let a=this.createPlayer(!0);a.getComponent("controller").socketId=o.socketId}),r.registerHandler("leave",o=>{let a=this.remotePlayers.find(h=>h.getComponent("controller").socketId==o.socketId);this.removeEntity(a),this.remotePlayers.splice(this.remotePlayers.indexOf(a),1)});break}}})}onPlayerConnect(){let e=this.player.getComponent("client")._channelClient.signalServer.socket.id;this.player.getComponent("controller").socketId=e}onPlayerDisconnect(){for(let e of this.remotePlayers)this.removeEntity(e);this.remotePlayers.length=0}onPlayerData(e){for(let i of e){if(i.socketId==this.player.getComponent("controller").socketId)continue;let s=this.remotePlayers.find(n=>n.getComponent("controller").socketId==i.socketId);if(s||(s=this.createPlayer(!0),s.getComponent("controller").socketId=i.socketId),i.data){let n=s.getComponent("controller");s.transform.position.copy(i.data.position),n._input=i.data.input,n._velocity.copy(i.data.velocity),n._grounded=i.data.grounded,n._climbing=i.data.climbing}}}createPlayer(e){let i=e?this.createEntity():this.createEntity("player");return i.addComponent("sprite",new d.graphics.AnimatedSpriteDrawable({sprite:new d.graphics.Sprite(A.getTexture("player")),size:new R(f,f),offset:new R,zIndex:2,camera:this.camera.main})),i.addComponent("collider",new d.geometry.Collider({offset:new R,shape:new d.geometry.shape.Rect(10,16)})),i.addComponent("controller",new mt({remote:e})),e&&this.remotePlayers.push(i),i}};d.Lancelot.init({container:document.body,width:960,height:540,scene:new vt,sceneParams:{},viewportMode:"fit",async preload(){A.addImage("bat",await ft("assets/bat.png")),A.addImage("tileset",await ft("assets/environment-tiles_extruded.png")),A.addImage("player",await ft("assets/player.png"));let t=await d.graphics.tilemap.Tilemap.loadFromJson("assets/test1.tmj",{"environment-tiles":"assets/environment-tiles.tsj"});d.utils.Store.set("tilemap",t),d.graphics.Animations.create("bat.fly",[{x:0,y:0,duration:.08},{x:1,y:0,duration:.08},{x:2,y:0,duration:.08},{x:3,y:0,duration:.08}],16,16,0,0),d.graphics.Animations.create("player.run",[{x:0,y:0,duration:.16},{x:1,y:0,duration:.16},{x:2,y:0,duration:.16},{x:1,y:0,duration:.16}],16,16,0,0),d.graphics.Animations.create("player.idle",[{x:1,y:1,duration:.16}],16,16,0,0),d.graphics.Animations.create("player.jump",[{x:0,y:1,duration:.16}],16,16,0,0),d.graphics.Animations.create("player.climb",[{x:4,y:0,duration:.16},{x:4,y:1,duration:.16}],16,16,0,0),A.createTexture("bat",A.getImage("bat"),{anim:d.graphics.Animations.get("bat.fly")},!0),A.createTexture("player",A.getImage("player"),{},!1)}});})();
